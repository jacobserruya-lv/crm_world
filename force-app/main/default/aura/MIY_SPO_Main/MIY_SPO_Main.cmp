<aura:component implements="force:hasRecordId" controller="MIY_OrderPageController">
    <aura:attribute name="record" type="Opportunity" />
    <aura:attribute name="recordId" type="String" />
    <aura:attribute name="lastStageChangeDate" type="DateTime" />
    <aura:attribute name="currentStatus" type="map" access="global"/>
    <aura:attribute name="statuses" type="List" default="[]" access="global"/>
    <aura:attribute name="editBriefAction" type="Aura.Action" />
    <aura:attribute name="userId" type="Id" default="" />
    <aura:attribute name="userProfile" type="String" />
    <aura:attribute name="warningsMap" type="Map" />
    <aura:attribute name="productSettings" type="ProductSettings__c" />
    <aura:attribute name="miySettings" type="Map" />
    <aura:attribute name="storeMode" type="Boolean"/>
    <aura:attribute name="workshopName" type="String" />
    <!-- MIY-2224 -->
    <aura:attribute name="isUserInPermissionSetGroup" type="Boolean"/>
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
    <aura:handler event="c:MIY_FirmOrderUpdate" action="{!c.handleUpdateEvent}" />
    <aura:handler name="render" value="{!this}" action="{!c.onRender}"/>
    <aura:handler name="change" value="{!v.storeMode}" action="{!c.handleStoreModeUpdate}"/>

    <lightning:overlayLibrary aura:id="overlayLib"/>

    <lightning:layout class="{!join(' ', 'spo-main', ('spo-main_status_' + v.currentStatus.key))}"
                      multipleRows="true"
                      verticalAlign="stretch"
    >
        <lightning:layoutItem size="12">
            <!--MIY-1751 change from plannedDeliveryDate="{!v.record.TECH_Order_Planned_Delivery_Date__c}" to Planned_Delivery_date__c of line item-->
            <!-- MIY-2224 add isUserInPermissionSetGroup -->
            <c:MIY_FirmOrderItemDetails itemData="{!v.record.SpeOrder_Order_Following__r[0]}"
                                        parentOrder="{!v.record}"
                                        isDisplayOrder="{!v.record.SPO_DisplayOrder__c}"
                                        currency="{!v.record.SPO_Store__r.Currency__c}"
                                        mainImgUrl="{!v.productSettings.BccSmallPictureUrl__c + v.record.SPO_BaseSKURefmodelSKU__r.ImageLink1__c}"
                                        currentStatus="{!v.currentStatus}"
                                        onActionClick="{!c.openProductDetailsModal}"
                                        actionIconStyle="{!v.storeMode ? 'none' : 'label'}"
                                        actionBtnLabel="Production Info"
                                        productName="{!v.record.Name}"
                                        inpirationSku="{!v.record.SPO_BaseSKURefmodelSKU__r.SKUCode__c}"
                                        productSku="{!v.record.SPO_Sku_Code_S__c}"
                                        showQuotationPdfLink="{!greaterthan(v.currentStatus.idx, 1)}"
                                        userProfile="{!v.userProfile}"
                                        plannedDeliveryDate="{!v.record.SpeOrder_Order_Following__r[0].Planned_Delivery_date__c}"
                                        quantity="{!v.record.SPO_SkuQuantity__c}"
                                        isUserInPermissionSetGroup="{!v.isUserInPermissionSetGroup}"
            />
        </lightning:layoutItem>
        <lightning:layoutItem size="12" class="spo-main__steps" aura:id="steps">
            <ui:scrollerWrapper class="outerScroller" aura:id="scrollerWrapper">
            <ol class="spo-main__steps-header slds-show_small">
                <aura:iteration items="{!v.statuses}" var="status" end="{!v.statuses.length - 3}">
                    <li class="{!join(' ','spo-main__step',
                            (lessthan(status.idx,v.currentStatus.idx) ? 'spo-main__step_past' : undefined)
                            )}"
                    >{!status.label}</li>
                </aura:iteration>
            </ol>
            <ol class="spo-main__steps-main">
                <aura:iteration items="{!v.statuses}" var="status" end="{!v.statuses.length - 3}">
                    <c:MIY_SPO_Stage status="{!status}"
                                     record="{!v.record}"
                                     currentStatusIdx="{!v.currentStatus.idx}"
                                     totalStageCount="{!v.statuses.length - 3}"
                                     userId="{!v.userId}"
                                     altAction="{!(status.key == 'brief-in-progress') ? v.editBriefAction : null}"
                                     pastAction="{!(status.key == 'brief-in-progress') ? v.editBriefAction : null}"
                                     warningsMap="{!v.warningsMap}"
                                     storeMode="{!v.storeMode}"
                                     workshopName="{!v.workshopName}"
                                     iconId ="{!status.iconId}"
                    />
                </aura:iteration>
            </ol>
            <aura:if isTrue="{!v.currentStatus.orderClosed}">
                <div class="spo-main__closed-overlay">
                    <lightning:icon src="{!'/resource/1602685985000/MakeItYours_Assets/images/lv-logo.svg#lv-logo'}" />
                    <aura:if isTrue="{!v.currentStatus.key == 'delivered'}">
                        <p class="spo-main__closed-notice slds-m-vertical_x-large">
                            <aura:if isTrue="{!and(not(empty(v.record)),not(empty(v.record.Account)))}">
                                <lightning:formattedUrl value="{!'/lightning/r/' + v.record.Account.Id + '/view'}"
                                                        tooltip="{!v.record.Account.Name}"
                                                        label="{!v.record.Account.Name}"
                                                        class="spo-main__closed-client-name"
                                />
                                <aura:set attribute="else"><span class="spo-main__closed-client-name">{!$Label.c.MIY_SPO_Main_The_Client + ' '}</span></aura:set>
                            </aura:if>&nbsp;{!$Label.c.MIY_SPO_Main_Receive_The_Product_Order_Closed}
                        </p>
                        <aura:set attribute="else">
                            <p class="spo-main__closed-notice slds-m-vertical_x-large">
                                <aura:if isTrue="{!v.currentStatus.key == 'cancelled-store'}">{!$Label.c.MIY_SPO_Main_Order_Cancelled_By_Store} - <ui:outputDate value="{!v.lastStageChangeDate}"/>.</aura:if>
                                <aura:if isTrue="{!v.currentStatus.key == 'cancelled-production'}">{!$Label.c.MIY_SPO_Main_Order_Cancelled_By_Production} - <ui:outputDate value="{!v.lastStageChangeDate}"/>.</aura:if>

                                <br />
                                <strong>{!$Label.c.MIY_SPO_Main_Reason_Comment} </strong>{!v.record.SPO_StopBriefReason__c}
                                <br />
                                <strong>{!$Label.c.MIY_SPO_Main_Comment_Reason} </strong>{!v.record.SPO_StopBriefComment__c}
                            </p>
                        </aura:set>
                    </aura:if>
                    <lightning:button label="Back to Orders" variant="brand" onclick="{!c.goToOrders}"/>
                </div>
            </aura:if>
            </ui:scrollerWrapper>
        </lightning:layoutItem>
        <aura:if isTrue="{!not(empty(v.record))}">
            <lightning:layoutItem size="12" class="spo-main__progress slds-progress slds-show_small">
                <ol class="slds-progress__list">
                    <li class="{!join(' ','slds-progress__item',
                            ((v.currentStatus.stageProgress != null) ? 'slds-is-active' : undefined))}"
                    >
                        <span class="slds-progress__marker"></span>
                        <dl class="spo-main__progress-stage-note">
                            <dt>{!$Label.c.MIY_SPO_Main_Brief_Created_At}</dt>
                            <dd><ui:outputDate value="{!v.record.CreatedDate}"/></dd>
                        </dl>
                    </li>
                    <li class="spo-main__progress-subnote">
                        <aura:if isTrue="{!v.currentStatus.key == 'quotation-in-progress'}">
                            {!$Label.c.MIY_SPO_Waiting_For_A_Quotation}

                            <span class="spo-main__progress-subnote-value">
                                <lightning:formattedNumber value="{!v.record.Duration_Quotation_in_progress__c}"
                                                           maximumFractionDigits="0"
                                /> {!$Label.c.MIY_SPO_Days}
                            </span>.
                        </aura:if>
                    </li>
                    <li class="{!join(' ','slds-progress__item',
                            (greaterthanorequal(v.currentStatus.stageProgress, 0.25) ? 'slds-is-active' : undefined))}"
                    >
                        <span class="slds-progress__marker"></span>
                        <dl class="spo-main__progress-stage-note">
                            <dt>{!$Label.c.MIY_SPO_Main_Quotation_Received}</dt>
                            <dd><ui:outputDate value="{!v.record.SPO_Date_Quotation_submitted__c}"/></dd>
                        </dl>
                    </li>
                    <li class="spo-main__progress-subnote">
                        <aura:if isTrue="{!greaterthanorequal(v.currentStatus.stageProgress, 0.25)}">
                            {!$Label.c.MIY_SPO_Main_Quotation_Price + ' '} <lightning:formattedNumber style="currency"
                                                                        class="spo-main__progress-subnote-value"
                                                                        currencyCode="{!v.record.SPO_Store__r.Currency__c}"
                                                                        value="{!v.record.Amount}"
                                                                        minimumFractionDigits="0"
                                                                        maximumFractionDigits="0"
                            />
                        </aura:if>
                    </li>
                    <li class="{!join(' ','slds-progress__item',
                            (greaterthanorequal(v.currentStatus.stageProgress, 0.5) ? 'slds-is-active' : undefined))}"
                    >
                        <span class="slds-progress__marker"></span>
                        <dl class="spo-main__progress-stage-note">
                            <dt>{!$Label.c.MIY_SPO_Main_Creation_Launched}</dt>
                            <dd><ui:outputDate value="{!v.record.SPO_Date_Creation_in_progress__c}"/></dd>
                        </dl>
                    </li>
                    <li class="spo-main__progress-subnote">
                        <aura:if isTrue="{!greaterthanorequal(v.currentStatus.stageProgress, 0.5)}">
                            <span class="spo-main__progress-subnote-value">{!$Label.c.MIY_SPO_Main_Deposit_Of + ' '}
                            <lightning:formattedNumber value="{!div(v.record.SPO_DepositAmount__c, v.record.Amount)}"
                                                       style="percent"
                            />&nbsp;{!$Label.c.MIY_SPO_Added + '  '}</span> {!$Label.c.MIY_SPO_Main_Document_Signed}
                        </aura:if>
                    </li>
                    <li class="{!join(' ','slds-progress__item',
                            (greaterthanorequal(v.currentStatus.stageProgress, 0.75) ? 'slds-is-active' : undefined))}"
                    >
                        <span class="slds-progress__marker"></span>
                        <dl class="spo-main__progress-stage-note">
                            <dt>{!$Label.c.MIY_SPO_Main_In_Delivery}</dt>
                            <dd><ui:outputDate value="{!v.record.SPO_Date_In_progress__c}"/></dd>
                        </dl>
                    </li>
                    <li class="spo-main__progress-subnote spo-main__progress-subnote_color_success">
                        <aura:if isTrue="{!greaterthanorequal(v.currentStatus.stageProgress, 0.875)}">
                            &nbsp; <span class="spo-main__progress-subnote-value">{!$Label.c.MIY_SPO_Main_Received_In_Store}
                                <ui:outputDate value="{!v.record.Received_in_Store_Date__c}"/>
                            </span>
                        </aura:if>
                    </li>
                    <li class="{!join(' ','slds-progress__item',
                            ((v.currentStatus.stageProgress == 1) ? 'slds-is-active' : undefined))}"
                    >
                        <span class="slds-progress__marker"></span>
                        <dl class="spo-main__progress-stage-note">
                            <dt>{!$Label.c.MIY_SPO_Deliver_To_Client}</dt>
                            <dd><ui:outputDate value="{!v.record.SPO_Date_Closed_Won__c}"/></dd>
                        </dl>
                    </li>
                </ol>
                <div class="slds-progress-bar slds-progress-bar_x-small"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     aria-valuenow="{!v.currentStatus.stageProgress * 100}"
                     role="progressbar"
                >
                    <span class="slds-progress-bar__value"
                          style="{!'width: ' +
                                  (v.currentStatus.stageProgress != null ? (v.currentStatus.stageProgress * 100) : 0) +
                                  '%'}"
                    >
                      <span class="slds-assistive-text">{!$Label.c.MIY_SPO_Main_Progress + v.currentStatus.stageProgress * 100}%</span>
                    </span>
                </div>
            </lightning:layoutItem>
        </aura:if>
        <aura:if isTrue="{!not($Browser.formFactor == 'DESKTOP')}">
            <lightning:layoutItem size="12" class="spo-main__collab">
                <c:MIY_Tabs recordId="{!v.recordId}" isUserInPermissionSetGroup="{!v.isUserInPermissionSetGroup}" />
            </lightning:layoutItem>
        </aura:if>
    </lightning:layout>
</aura:component>